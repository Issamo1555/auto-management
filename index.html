<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoManager - Gestion V√©hicules</title>

    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AutoManager">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <link rel="stylesheet" href="css/main.css?v=1.3">
    <link rel="stylesheet" href="css/comparator.css?v=1.0">
    <!-- Google Fonts: Inter for a premium feel -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Chart.js for statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- html5-qrcode for QR scanning -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <!-- QRCode.js for QR generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function (registrations) {
                for (let registration of registrations) {
                    registration.unregister();
                    console.log('Service Worker unregistered');
                }
            });
        }
    </script>
</head>

<body>
    <div id="app">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="brand">
                <div class="logo-icon">‚ñ∂</div>
                <h1>AutoManager</h1>
            </div>
            <ul class="nav-links">
                <li class="active" data-view="dashboard">
                    <span class="icon">‚ñ†</span> Tableau de bord
                </li>
                <li data-view="vehicles">
                    <span class="icon">‚ñ∂</span> V√©hicules
                </li>
                <li data-view="documents">
                    <span class="icon">üìÑ</span> Documents
                </li>
                <li data-view="providers">
                    <span class="icon">üîß</span> Fournisseurs
                </li>
                <li data-view="best-route">
                    <span class="icon">üó∫Ô∏è</span> Meilleur trajet
                </li>
                <li data-view="parking">
                    <span class="icon">üÖøÔ∏è</span> Parking Marrakech
                </li>
                <li data-view="car-advisor">
                    <span class="icon">üí°</span> Conseiller d'Achat
                </li>
                <li data-view="maintenance">
                    <span class="icon">‚öí</span> Entretien
                </li>
                <li data-view="settings">
                    <span class="icon">‚öô</span> Param√®tres
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <button class="menu-toggle" id="menu-toggle">‚ò∞</button>
                <div class="search-container">
                    <input type="text" id="global-search" placeholder="Rechercher..." autocomplete="off">
                    <div id="search-results" class="search-results hidden"></div>
                </div>
                <h2 id="page-title">Tableau de bord</h2>
                <div class="user-profile">
                    <button id="voice-assistant-btn" class="btn-icon" title="Assistant Vocal">
                        üé§
                        <span class="status-badge" style="display: none;"></span>
                    </button>
                    <button id="qr-scanner-btn" class="btn-icon" title="Scanner QR Code">
                        üì±
                        <span class="status-badge" style="display: none;"></span>
                    </button>
                    <button id="theme-toggle" class="btn-icon" title="Changer de th√®me">üåì</button>
                    <span class="notification-badge" id="notification-bell">‚óâ</span>
                    <div class="avatar" id="user-avatar">U</div>
                </div>
            </header>

            <!-- Notification Panel -->
            <div id="notification-panel" class="dropdown-panel hidden">
                <div class="panel-header">
                    <h4>Notifications</h4>
                    <button class="close-panel" id="close-notifications">‚úñ</button>
                </div>
                <div class="panel-content" id="notification-list">
                    <!-- Notifications will be loaded here -->
                </div>
            </div>

            <div id="view-documents" class="view-section hidden">
                <!-- Documents Module -->
            </div>

            <div id="view-providers" class="view-section hidden">
                <!-- Providers Module -->
            </div>
            <!-- User Menu -->
            <div id="user-menu" class="dropdown-panel hidden">
                <div class="panel-header">
                    <h4>Mon Compte</h4>
                    <button class="close-panel" id="close-user-menu">‚úñ</button>
                </div>
                <div class="panel-content">
                    <div class="menu-item" data-action="settings">
                        <span class="menu-icon">‚öô</span>
                        <span>Param√®tres</span>
                    </div>
                    <div class="menu-item" data-action="export">
                        <span class="menu-icon">‚Üì</span>
                        <span>Exporter les donn√©es</span>
                    </div>
                    <div class="menu-item" data-action="about">
                        <span class="menu-icon">‚Ñπ</span>
                        <span>√Ä propos</span>
                    </div>
                </div>
            </div>

            <div id="view-container" class="content-area">
                <!-- Dynamic Content Will Be Injected Here -->
                <div class="welcome-card">
                    <h3>Bienvenue sur AutoManager</h3>
                    <p>S√©lectionnez une option dans le menu pour commencer.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Sidebar Overlay -->
    <!-- Auth Screen -->
    <div id="auth-screen" class="auth-screen hidden">
        <div class="auth-container">
            <div class="auth-icon">‚óÜ</div>
            <h2>Verrouill√©</h2>
            <p>Entrez votre code PIN pour acc√©der</p>

            <div class="pin-display">
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
            </div>

            <div class="keypad">
                <button class="key" data-key="1">1</button>
                <button class="key" data-key="2">2</button>
                <button class="key" data-key="3">3</button>
                <button class="key" data-key="4">4</button>
                <button class="key" data-key="5">5</button>
                <button class="key" data-key="6">6</button>
                <button class="key" data-key="7">7</button>
                <button class="key" data-key="8">8</button>
                <button class="key" data-key="9">9</button>
                <button class="key action" data-key="clear">C</button>
                <button class="key" data-key="0">0</button>
                <button class="key action" data-key="back">‚å´</button>
            </div>

            <button id="btn-biometric-auth" class="btn-icon-large hidden"
                style="margin-bottom: 1rem; background: none; border: none; font-size: 2.5rem; cursor: pointer;">
                üÜî
            </button>

            <button id="btn-forgot-pin" class="btn-text small">Code oubli√© ?</button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="modal-confirm" class="modal hidden">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h4>Confirmation</h4>
                <span class="close-modal" id="close-confirm-modal">&times;</span>
            </div>
            <div class="modal-body">
                <p id="confirm-message">√ätes-vous s√ªr ?</p>
                <div class="form-actions" style="margin-top: 1.5rem;">
                    <button id="btn-confirm-cancel" class="btn btn-secondary">Annuler</button>
                    <button id="btn-confirm-ok" class="btn btn-danger">Supprimer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Provider Search Modal -->
    <div id="modal-provider-search" class="modal hidden">
        <div class="modal-content" style="max-width:900px;">
            <div class="modal-header">
                <h4>üîç Trouver un Fournisseur</h4>
                <span class="close-modal">&times;</span>
            </div>
            <form id="form-provider-search">
                <div class="form-row">
                    <div class="form-group">
                        <label>Ville</label>
                        <select id="provider-city" required class="form-select">
                            <option value="">S√©lectionner une ville</option>
                            <option value="Marrakech">Marrakech</option>
                            <option value="Casablanca">Casablanca</option>
                            <option value="Rabat">Rabat</option>
                            <option value="F√®s">F√®s</option>
                            <option value="Tanger">Tanger</option>
                            <option value="Agadir">Agadir</option>
                            <option value="Mekn√®s">Mekn√®s</option>
                            <option value="Oujda">Oujda</option>
                            <option value="K√©nitra">K√©nitra</option>
                            <option value="T√©touan">T√©touan</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Type de service</label>
                        <select id="provider-service-type" required class="form-select">
                            <option value="">S√©lectionner un service</option>
                            <option value="Vidange">Vidange</option>
                            <option value="R√©vision">R√©vision</option>
                            <option value="Freins">Freins</option>
                            <option value="Pneus">Pneus</option>
                            <option value="Climatisation">Climatisation</option>
                            <option value="Diagnostic">Diagnostic</option>
                            <option value="Carrosserie">Carrosserie</option>
                            <option value="Peinture">Peinture</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Marque du v√©hicule (optionnel)</label>
                        <input type="text" id="provider-vehicle-brand" placeholder="ex: Renault">
                    </div>
                    <div class="form-group">
                        <label>Budget (optionnel)</label>
                        <select id="provider-price-range" class="form-select">
                            <option value="">Tous</option>
                            <option value="$">üíµ √âconomique</option>
                            <option value="$$">üíµüíµ Moyen</option>
                            <option value="$$$">üíµüíµüíµ Premium</option>
                        </select>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" id="btn-search-providers" class="btn btn-primary">
                        ü§ñ Rechercher avec IA
                    </button>
                </div>
            </form>
            <div id="provider-results" style="margin-top:1.5rem;">
                <!-- Results will be displayed here -->
            </div>
        </div>
    </div>

    <!-- Voice Assistant Modal -->
    <div id="voice-assistant-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h4>üé§ Assistant Vocal</h4>
                <span class="close-modal"
                    onclick="window.VoiceAssistant.stopListening(); this.closest('.modal').classList.add('hidden');">&times;</span>
            </div>
            <div class="modal-body">
                <div class="voice-assistant-container">
                    <div class="voice-indicator idle"></div>
                    <p class="voice-status">üé§ Pr√™t √† √©couter</p>
                    <p class="voice-transcript" style="display: none;"></p>
                    <p class="voice-response" style="display: none;"></p>
                    <div class="form-actions" style="margin-top: 1.5rem;">
                        <button class="btn btn-primary" onclick="window.VoiceAssistant.startListening()">üé§
                            Commencer</button>
                        <button class="btn btn-secondary" onclick="window.VoiceAssistant.stopListening()">‚èπÔ∏è
                            Arr√™ter</button>
                    </div>
                    <div class="voice-help" style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-secondary);">
                        <p><strong>Exemples de commandes :</strong></p>
                        <ul style="list-style: none; padding-left: 0;">
                            <li>‚Ä¢ "Ouvrir v√©hicules"</li>
                            <li>‚Ä¢ "Combien de v√©hicules"</li>
                            <li>‚Ä¢ "Prochain entretien"</li>
                            <li>‚Ä¢ "Arr√™ter"</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Scanner Modal -->
    <div id="qr-scanner-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h4>üì± Scanner QR Code</h4>
                <span class="close-modal" onclick="window.QRScanner.closeModal();">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Tabs -->
                <div class="qr-tabs">
                    <button class="qr-tab-btn active" data-tab="scan" onclick="window.QRScanner.switchTab('scan')">
                        üîç Scanner
                    </button>
                    <button class="qr-tab-btn" data-tab="generate" onclick="window.QRScanner.switchTab('generate')">
                        ‚ú® G√©n√©rer
                    </button>
                </div>

                <!-- Scanner Tab -->
                <div id="qr-scan-tab" class="qr-tab-content">
                    <p class="scanner-status">üì∑ Pr√™t √† scanner</p>
                    <div id="qr-reader" style="width: 100%; margin: 1rem 0;"></div>
                    <div class="qr-result" style="display: none;"></div>
                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="window.QRScanner.closeModal()">Fermer</button>
                        <button class="btn btn-primary" onclick="window.QRScanner.startScanning()">
                            üì∑ D√©marrer Scanner
                        </button>
                        <button class="btn btn-secondary" onclick="window.QRScanner.switchCamera()"
                            id="switch-camera-btn" style="display: none;">
                            üîÑ Changer Cam√©ra
                        </button>
                    </div>
                </div>

                <!-- Generate Tab -->
                <div id="qr-generate-tab" class="qr-tab-content" style="display: none;">
                    <div class="form-group">
                        <label>S√©lectionner un v√©hicule</label>
                        <select id="vehicle-select-qr" class="form-select">
                            <option value="">S√©lectionner un v√©hicule</option>
                        </select>
                    </div>
                    <div id="qr-code-display" style="text-align: center; margin: 1.5rem 0; min-height: 256px;"></div>
                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="window.QRScanner.closeModal()">Fermer</button>
                        <button class="btn btn-primary"
                            onclick="const vehicleId = document.getElementById('vehicle-select-qr').value; if(vehicleId) window.QRScanner.generateVehicleQR(vehicleId); else alert('S√©lectionnez un v√©hicule');">
                            ‚ú® G√©n√©rer QR Code
                        </button>
                        <button class="btn btn-secondary" id="download-qr-btn" style="display: none;">
                            üíæ T√©l√©charger
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Car Advisor Modal -->
    <div id="modal-car-advisor" class="modal hidden">
        <div class="modal-content" style="max-width: 800px; height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h4>üí° Conseiller d'Achat</h4>
                <span class="close-modal" id="close-advisor-modal"
                    onclick="document.getElementById('modal-car-advisor').classList.add('hidden')">&times;</span>
            </div>

            <div class="advisor-container" style="flex: 1; overflow-y: auto; padding: 0;">
                <!-- Progress Bar -->
                <div class="advisor-progress">
                    <div class="progress-track">
                        <div class="progress-fill" id="advisor-progress-fill" style="width: 25%;"></div>
                    </div>
                    <div class="progress-steps">
                        <div class="step active" data-step="1">1. Budget</div>
                        <div class="step" data-step="2">2. Usage</div>
                        <div class="step" data-step="3">3. Tech</div>
                        <div class="step" data-step="4">4. Pr√©f√©rences</div>
                    </div>
                </div>

                <!-- Wizard Content -->
                <div class="advisor-content" id="advisor-content">
                    <!-- Steps will be injected here by JS -->
                </div>
            </div>

            <div class="modal-footer"
                style="padding: 1.5rem; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between;">
                <button id="btn-advisor-prev" class="btn btn-secondary" disabled>Pr√©c√©dent</button>
                <button id="btn-advisor-next" class="btn btn-primary">Suivant</button>
            </div>
        </div>
    </div>

    <!-- Vehicle Comparator Modal -->
    <div id="modal-comparator" class="modal hidden">
        <div class="modal-content" style="max-width: 95vw; height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h4>‚öñÔ∏è Comparateur de V√©hicules</h4>
                <span class="close-modal"
                    onclick="document.getElementById('modal-comparator').classList.add('hidden')">&times;</span>
            </div>
            <div class="modal-body" style="flex: 1; overflow: auto; padding: 0;">
                <div id="comparator-content" class="comparator-container">
                    <!-- Comparison table will be injected here -->
                </div>
            </div>
            <div class="modal-footer"
                style="padding: 1rem; border-top: 1px solid var(--border-color); text-align: right;">
                <button class="btn btn-secondary"
                    onclick="document.getElementById('modal-comparator').classList.add('hidden')">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Best Route Modal -->
    <div id="modal-best-route" class="modal hidden">
        <div class="modal-content" style="max-width: 95vw; height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h4>üó∫Ô∏è Meilleur Trajet</h4>
                <span class="close-modal" onclick="window.BestRouteManager.closeRouteModal()">&times;</span>
            </div>
            <div class="modal-body" style="flex: 1; overflow: hidden; display: flex; gap: 1rem; padding: 0;">
                <!-- Left Panel: Form & Results -->
                <div
                    style="width: 350px; padding: 1.5rem; overflow-y: auto; border-right: 1px solid var(--border-color);">
                    <h3 style="margin-top: 0;">Planifier votre trajet</h3>

                    <!-- Origin -->
                    <div class="form-group">
                        <label>üìç Point de d√©part</label>
                        <input type="text" id="route-origin" placeholder="Adresse de d√©part" class="form-control">
                        <button class="btn btn-secondary" style="margin-top: 0.5rem; width: 100%;"
                            onclick="window.BestRouteManager.useCurrentLocation()">
                            üìç Ma position actuelle
                        </button>
                    </div>

                    <!-- Waypoints -->
                    <div class="form-group">
                        <label>üîß Points d'arr√™t (garages/fournisseurs)</label>
                        <div id="waypoints-list" style="margin-bottom: 0.5rem;">
                            <!-- Waypoints will be added here -->
                        </div>
                        <input type="text" id="waypoint-input" placeholder="Adresse du garage" class="form-control">
                        <button class="btn btn-primary" style="margin-top: 0.5rem; width: 100%;"
                            onclick="window.BestRouteManager.addWaypointFromInput()">
                            ‚ûï Ajouter un arr√™t
                        </button>
                    </div>

                    <!-- Destination (optional) -->
                    <div class="form-group">
                        <label>üèÅ Destination finale (optionnel)</label>
                        <input type="text" id="route-destination" placeholder="Retour √†..." class="form-control">
                        <small style="color: var(--text-secondary);">Laissez vide pour terminer au dernier arr√™t</small>
                    </div>

                    <!-- Calculate Button -->
                    <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;"
                        onclick="window.BestRouteManager.calculateRoute()">
                        üöó Calculer l'itin√©raire optimal
                    </button>

                    <!-- Route Details -->
                    <div id="route-details" style="margin-top: 1.5rem;">
                        <!-- Route summary will be displayed here -->
                    </div>
                </div>

                <!-- Right Panel: Map -->
                <div style="flex: 1; position: relative;">
                    <div id="route-map" style="width: 100%; height: 100%; border-radius: 8px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Parking Finder Modal -->
    <div id="modal-parking-finder" class="modal hidden">
        <div class="modal-content" style="max-width: 95vw; height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h4>üÖøÔ∏è Trouver un Parking √† Marrakech</h4>
                <span class="close-modal" onclick="window.ParkingFinder.closeModal()">&times;</span>
            </div>
            <div class="modal-body" style="flex: 1; overflow: hidden; display: flex; gap: 1rem; padding: 0;">
                <!-- Left Panel: Search & Results -->
                <div
                    style="width: 350px; padding: 1.5rem; overflow-y: auto; border-right: 1px solid var(--border-color);">
                    <h3 style="margin-top: 0;">Rechercher un parking</h3>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="use-current-location">
                            <span>üìç Utiliser ma position actuelle</span>
                        </label>
                        <small style="color: var(--text-secondary); display: block; margin-top: 0.25rem;">
                            Sinon, recherche depuis le centre de Marrakech
                        </small>
                    </div>

                    <button class="btn btn-primary" id="btn-search-parking" style="width: 100%; margin-top: 1rem;"
                        onclick="window.ParkingFinder.searchFromUI()">
                        üîç Rechercher des parkings
                    </button>

                    <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--border-color);">

                    <!-- Parking List -->
                    <div id="parking-list">
                        <p style="color: var(--text-secondary); text-align: center;">
                            Cliquez sur "Rechercher" pour trouver des parkings disponibles
                        </p>
                    </div>
                </div>

                <!-- Right Panel: Map -->
                <div style="flex: 1; position: relative;">
                    <div id="parking-map" style="width: 100%; height: 100%; border-radius: 8px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/config.js?v=1.4.0"></script>
    <script src="js/utils.js?v=1.4.0"></script>
    <script src="js/auth.js?v=1.4.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/charts.js?v=1.4.0"></script>
    <script src="js/storage.js?v=1.4.0"></script>
    <script src="js/car_data.js?v=1.4.0"></script>
    <script src="js/provider_data.js?v=1.4.0"></script>
    <script src="js/provider_manager.js?v=1.4.0"></script>
    <script src="js/provider_ui.js?v=1.4.0"></script>
    <script src="js/ai_service.js?v=1.6.0"></script>
    <script src="js/provider_search.js?v=1.4.0"></script>
    <script src="js/vehicles_database.js?v=1.5.0"></script>
    <script src="js/car_advisor.js?v=1.5.0"></script>
    <script src="js/voice_assistant.js?v=1.5.0"></script>
    <script src="js/qr_scanner.js?v=1.5.0"></script>
    <script src="js/comparator.js?v=1.0"></script>
    <script src="js/best_route.js?v=1.0"></script>
    <script src="js/parking_finder.js?v=1.0"></script>
    <script src="js/vehicle.js?v=1.4.0"></script>
    <script src="js/document.js?v=1.4.0"></script>
    <script src="js/maintenance.js?v=1.4.0"></script>
    <script src="js/dashboard.js?v=1.4.0"></script>
    <script src="js/notification.js?v=1.4.0"></script>
    <script src="js/settings.js?v=1.4.0"></script>
    <script src="js/ui.js?v=1.4.0"></script>
    <script src="js/app.js?v=1.4.0"></script>
</body>

</html>